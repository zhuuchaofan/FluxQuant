**FluxQuant** **管理端详细设计说明书** **(Admin Control Layer)**

文档状态: Draft

对应角色: 项目经理 / 组长 / 审计员

核心目标: 全局上帝视角 (God View)、动态资源调度、异常阻断与归因

**1.** **设计哲学** **(Design Philosophy)**

管理端不是为了“监视”员工，而是为了**“平衡”系统**。

- **流式管理**: 关注点在“瓶颈”在哪里，而不是谁在摸鱼。
- **动态调整**: 承认现实世界的混乱（总量会变、需求会变），系统必须提供“后悔药”和“调节阀”。
- **数据驱动**: 用“除外率”倒逼上游数据质量，而不是用“完成率”逼迫下游员工。

**2.** **核心界面：分配矩阵** **(The Allocation Matrix)**

这是管理端最复杂的视图，采用类似于 Excel/Airtable 的 **Pivot Table (\*\***透视表\***\*)** 交互。

**2.1** **视图结构**

- **行维度** **(Rows)**: 任务池 (Task Pools)，按 Stage 分组折叠。
- **列维度** **(Cols)**:
  - 固定列: 任务名, 当前总量, 进度条
  - 动态列: 未分配量, 张三, 李四, 王五 ... (所有 Team Member)
  - 汇总列: 已分配总量, 异常总量

**2.2** **单元格交互** **(Cell Interaction)**

每个 [User] x [Task] 的交叉点是一个**可编辑单元格**。

- **显示**:
  - 数字: 分配额度 (如 200)。
  - 状态: 如果该用户已完成，显示绿色下划线；如果进度滞后，显示黄色背景。
- **编辑**:
  - 点击单元格 -> 输入新数字 -> 回车。
  - **自动计算**: 修改后，未分配量 列自动更新。
  - **溢出校验**: 如果 Sum(Users) > TotalQuota，未分配量 显示为负数（红色），如 -50。系统允许保存，但给予视觉警告。

**2.3** **批量操作** **(Batch Actions)**

- **行操作**: 选中某一行（任务），点击“自动均分”。系统将 未分配量 平均分给选中的列。
- **列操作**: 选中“张三”列，点击“清空未完成”。用于员工离职或请假时的任务释放。

**3.** **核心功能：动态配额与调整** **(Dynamic Quota)**

解决“老板加需求”或“数据源扩容”的场景。

**3.1** **调整流程** **(Adjustment Flow)**

1. 点击任务行的 当前总量 数字（如 5000）。
2. 弹出 **"\*\***调整总量\***\*"** 对话框。
3. **操作**:
   - 方式 A: 增量调整 (输入 +500)。
   - 方式 B: 覆盖调整 (输入 5500)。

4. **审计** **(Mandatory)**: 必须填写 变更原因 (如: "客户追加 1/17 数据包")。
5. **影响预演**:

- 系统提示: "调整后，当前项目总进度将从 80% 下降至 72%。"

**3.2** **影响传播**

- TaskPool.CurrentTotalQuota 更新。
- Log 表写入一条 PoolAdjustmentLog。
- 矩阵视图中的 未分配量 自动增加。

**4.** **深度分析：异常监控** **(Anomaly Detection)**

**4.1** **异常热力图** **(Exclusion Heatmap)**

- **X\*\***轴\*\*: 日期。
- **Y\*\***轴\*\*: 任务阶段。
- **色块**: 颜色越深代表 除外率 (Excluded / Total) 越高。
- **洞察**:
  - 如果某一天全红，说明那天的数据源整体有问题。
  - 如果某一个任务长期红，说明该任务定义不明确或上游交付质量低。

**4.2** **归因分析** **(Reason Breakdown)**

- 饼图展示：
  - 源文件损坏: 45% -> **Action**: 联系 IT 修复文件服务。
  - 重复数据: 30% -> **Action**: 优化去重算法。
  - 操作员不会做: 5% -> **Action**: 安排培训。

**5.** **技术实现细节** **(Tech Implementation)**

**5.1** **前端性能优化** **(Next.js)**

矩阵视图可能包含 50行 x 20列 = 1000 个单元格。

- **虚拟滚动** **(Virtualization)**: 使用 tanstack-virtual，只渲染可视区域的单元格，保证 60fps 流畅度。
- **防抖保存** **(Debounce Save)**: 用户快速输入时，前端暂存状态，停止输入 500ms 后再发送 API 请求，减少后端压力。

**5.2** **后端聚合逻辑** **(C# LINQ)**

// 获取矩阵数据的伪代码
var matrixData = await \_context.TaskPools
.Include(p => p.Allocations)
.Select(pool => new MatrixRowDto {
TaskId = pool.Id,
TotalQuota = pool.CurrentTotalQuota,
Allocations = pool.Allocations.Select(a => new {
UserId = a.UserId,
Quota = a.TargetQuota,
Progress = a.CurrentValid
}),
// 关键：后端直接计算未分配量，减少前端逻辑
Unassigned = pool.CurrentTotalQuota - pool.Allocations.Sum(a => a.TargetQuota)
})
.ToListAsync();

**6.** **预期交付成果** **(Deliverables)**

1. **管理后台**:
   - 分配矩阵页面 (/admin/matrix)。
   - 仪表盘页面 (/admin/dashboard)。
   - 审计日志页面 (/admin/audit)。

1. **核心算法**:

- AutoBalanceService: 自动配平算法。
- QuotaAdjustmentService: 总量调整与日志记录服务。

1. **价值体现**:

- 项目经理能在一分钟内完成 5 人 x 10 任务的工作分配。
- 所有的进度回退（因总量增加）都有据可查，不再背黑锅。

**7.** **技术落地指南** **(Technical Guidelines)**

**7.1** **矩阵渲染优化**

- **库**: 必须使用 `@tanstack/react-virtual` 处理行列虚拟化。
- **状态管理**: 使用 `nuqs` (URL State) 存储筛选条件，保证链接可分享。

**7.2** **实时协同**

- **SignalR**: 仅在管理端矩阵页面建立连接。
- **Hub**: `MatrixHub`
- **Events**:
  - `ReceiveAllocationUpdate(allocationId, newValid, newExcluded)`
  - `ReceivePoolUpdate(poolId, newTotal)`
- **前端处理**: 收到事件后，只更新 React Query Cache (`queryClient.setQueryData`)，触发局部重渲染。
