**FluxQuant** **å‘˜å·¥ç«¯è¯¦ç»†è®¾è®¡è¯´æ˜ä¹¦** **(Execution Layer)**

æ–‡æ¡£çŠ¶æ€: Draft

å¯¹åº”è§’è‰²: æ•°æ®ä¸“å‘˜ / æ“ä½œå‘˜ / å¼€å‘è€…

æ ¸å¿ƒç›®æ ‡: æä½æ‘©æ“¦å½•å…¥ (Low Friction)ã€é«˜é¢‘æ­£åé¦ˆ (High Feedback)ã€å…è´£æœºåˆ¶æ•°å­—åŒ–

**1.** **è®¾è®¡å“²å­¦** **(Design Philosophy)**

åœ¨ä¼ ç»Ÿçš„ ERP æˆ–å·¥æ—¶ç³»ç»Ÿä¸­ï¼Œå‘˜å·¥æ˜¯è¢«åŠ¨çš„â€œæ•°æ®å½•å…¥æœºå™¨â€ã€‚åœ¨ FluxQuant ä¸­ï¼Œæˆ‘ä»¬å°†å¡«æŠ¥è¡Œä¸ºæ¸¸æˆåŒ–ï¼ˆGamificationï¼‰ï¼š

- **æ¶ˆé™¤ææƒ§**: é‡åˆ°åæ•°æ®ï¼ˆæ— æ³•å¤„ç†çš„ä»»åŠ¡ï¼‰æ—¶ï¼Œä¸ä»…ä¸æ‰£åˆ†ï¼Œåè€Œè§†ä¸ºä¸€ç§â€œå¯¹äºæ•°æ®æ¸…æ´—çš„è´¡çŒ®â€ã€‚
- **å³æ—¶æ»¡è¶³**: æ¯ä¸€æ¬¡æäº¤ï¼Œè¿›åº¦æ¡å¿…é¡»å®æ—¶å“åº”ï¼ˆæ— éœ€ç­‰å¾…æœåŠ¡å™¨ï¼‰ã€‚
- **ç§å¯†æ€§**: å‘˜å·¥ç«¯åªå…³æ³¨â€œæˆ‘çš„æµâ€ï¼Œå±è”½é¡¹ç›®æ•´ä½“çš„å¤æ‚æ€§ã€‚

**2.** **æ ¸å¿ƒç•Œé¢ï¼šå·¥ä½œæµè§†å›¾** **(My Stream)**

**2.1** **å¸ƒå±€æ¶æ„**

é‡‡ç”¨ **"\*\***ç§»åŠ¨ç«¯ä¼˜å…ˆ (Mobile First)\***\*"** ç­–ç•¥ã€‚

- **Mobile**: å•åˆ—å¡ç‰‡æµ (1 Col)ã€‚
- **Desktop**: å±…ä¸­é™åˆ¶å®½åº¦çš„å•åˆ—æµ (Max-Width 600px)ï¼Œä¿æŒä¸ç§»åŠ¨ç«¯ä¸€è‡´çš„ä¸“æ³¨ä½“éªŒã€‚

- **é¡¶éƒ¨å¯¼èˆª**:
  - å·¦ä¾§: FluxQuant Logo
  - å³ä¾§: ä»Šæ—¥äº§å‡º: 320 (å®æ—¶è·³åŠ¨çš„æ•°å­—è®¡æ•°å™¨) | ç”¨æˆ·å¤´åƒ
- **ä¸»ä½“åŒºåŸŸ**:
  - **Filter (\*\***è¿‡æ»¤å™¨\***\*)**: å…¨éƒ¨ä»»åŠ¡ | è¿›è¡Œä¸­ | å·²å®Œæˆ
  - **Card List**: å‚ç›´æ’åˆ—çš„åˆ†é…ä»»åŠ¡å¡ç‰‡ã€‚

**2.2** **ä»»åŠ¡å¡ç‰‡è®¾è®¡** **(The Task Card)**

æ¯å¼ å¡ç‰‡ä»£è¡¨ä¸€ä¸ª Allocation å®ä¾‹ã€‚

| **åŒºåŸŸ**   | **å…ƒç´ **                           | **é€»è¾‘\*\***/\***\*è¯´æ˜**                             |
| ---------- | ---------------------------------- | ----------------------------------------------------- |
| **Header** | é˜¶æ®µæ ‡ç­¾                           | å¦‚ [æ•°æ®æ¸…æ´—]ï¼Œé¢œè‰²åŒºåˆ†é˜¶æ®µã€‚                         |
|            | ä»»åŠ¡åç§°                           | å¦‚ 2026Q1*åˆåŒæ‰«æä»¶*æ‰¹æ¬¡Aã€‚                          |
| **Body**   | è¿›åº¦ä»ªè¡¨ç›˜                         | ç¯å½¢å›¾æˆ–æ¡å½¢å›¾ã€‚æ˜¾ç¤º å·²å®Œæˆ / ç›®æ ‡é‡ (å¦‚ 150 / 200)ã€‚ |
|            | å‰©ä½™æç¤º                           | è¿˜éœ€ 50 ä¸ªå•ä½ã€‚                                      |
| **Action** | **â€œ\*\***æ±‡æŠ¥\***\*â€\*\***æŒ‰é’®\*\* | **ä¸»äº¤äº’ç‚¹**ã€‚å¤§å°ºå¯¸ã€é«˜å¯¹æ¯”åº¦æŒ‰é’®ã€‚                  |
| **Footer** | å†å²æ‘˜è¦                           | æ˜¾ç¤ºæœ€è¿‘ä¸€æ¬¡æäº¤ï¼šä»Šå¤© 10:30 (+20)ã€‚                  |

**3.** **æ ¸å¿ƒäº¤äº’ï¼šæ²‰æµ¸å¼å¡«æŠ¥** **(The Reporting Flow)**

ç‚¹å‡»â€œæ±‡æŠ¥â€æŒ‰é’®åï¼Œä¸è·³è½¬é¡µé¢ï¼Œè€Œæ˜¯å¼¹å‡ºä¸€ä¸ª**åŠå±æ¨¡æ€çª—** **(Bottom Sheet / Modal)**ã€‚

**3.1** **å¡«æŠ¥æ¨¡æ€çª—** **(Report Modal)**

**A** **åŒºï¼šæ—¥æœŸç¡®è®¤**

- é»˜è®¤é€‰ä¸­â€œä»Šå¤©â€ã€‚
- å…è®¸å›æº¯é€‰æ‹©â€œæ˜¨å¤©â€æˆ–â€œå‰å¤©â€ï¼ˆè¡¥æŠ¥æ¨¡å¼ï¼Œéœ€åœ¨åå°æ ‡è®° IsBackfill: trueï¼‰ã€‚

**B** **åŒºï¼šæœ‰æ•ˆäº§å‡º** **(Valid Output)**

- **æ–‡æ¡ˆ**: "ä»Šå¤©æå®šäº†å¤šå°‘ï¼Ÿ"
- **ç»„ä»¶**: å¤§å­—å·æ•°å­—è¾“å…¥æ¡†ã€‚
- **å¿«æ·é”®**: +10, +50, Max (å¡«æ»¡å‰©ä½™é‡)ã€‚

**5.3** **æ™ºèƒ½è¾…åŠ©** **(Smart Features)**

- **è®°å¿†åŠŸèƒ½ (Smart Memory)**:
  - ç³»ç»Ÿè‡ªåŠ¨è®°ä½ç”¨æˆ·ä¸Šä¸€æ¬¡é€‰æ‹©çš„ "é™¤å¤–åŸå› "ã€‚
  - åœºæ™¯: è‹¥æœåŠ¡å™¨å®•æœºï¼Œç”¨æˆ·åªéœ€é€‰ä¸€æ¬¡åŸå› ï¼Œåç»­å¡«æŠ¥è‡ªåŠ¨å¡«å……è¯¥é€‰é¡¹ï¼Œè¿›ä¸€æ­¥é™ä½æ‘©æ“¦ã€‚
- **å®Œæˆæ¿€åŠ±**:
  - å½“è¿›åº¦è¾¾åˆ° 100% (Target Quota)ï¼Œæ’­æ”¾å…¨å±å¾®åŠ¨ç”» (Confetti/Fireworks)ã€‚
  - å¡ç‰‡çŠ¶æ€å˜ä¸ºç»¿è‰²ï¼Œå¹¶æ˜¾ç¤º "All Set!" å›¾æ ‡ã€‚

**C** **åŒºï¼šå¼‚å¸¸\*\***/\***\*é™¤å¤–** **(Exceptions / Exclusions) â€”â€”** **å…³é”®è®¾è®¡**

- **é»˜è®¤çŠ¶æ€**: æŠ˜å æ”¶èµ·ï¼Œæ–‡æ¡ˆ "é‡åˆ°æ— æ³•å¤„ç†çš„æ•°æ®ï¼Ÿ"ã€‚
- **å±•å¼€çŠ¶æ€**:
  1. **æ•°é‡**: è¾“å…¥é™¤å¤–æ•°é‡ï¼ˆå¦‚ 5ï¼‰ã€‚
  2. **åŸå› ** **(\*\***å¿…é€‰\***\*)**: Dropdown é€‰æ‹©ã€‚
     - æºæ–‡ä»¶æŸå / æ— æ³•æ‰“å¼€
     - æ•°æ®é‡å¤ / å·²å­˜åœ¨
     - ä¿¡æ¯ç¼ºå¤± / æ— æ³•è¾¨è®¤
     - å…¶ä»– (éœ€å¤‡æ³¨)

1. **å¤‡æ³¨**: Textareaï¼Œç”¨äºç²˜è´´åæ•°æ®çš„æ–‡ä»¶åæˆ– IDã€‚

**D** **åŒºï¼šæäº¤åé¦ˆ**

- æŒ‰é’®æ–‡æ¡ˆåŠ¨æ€å˜åŒ–: æäº¤ (æ€»è¿›åº¦å°†å‡è‡³ 82%) ğŸš€ã€‚

**3.2** **äº¤äº’æ—¶åº** **(Sequence)**

1. **User**: è¾“å…¥ Valid: 50, Excluded: 5 -> ç‚¹å‡»æäº¤ã€‚
2. **Frontend (Next.js)**:
   - **Optimistic UI**: ç«‹å³å…³é—­å¼¹çª—ï¼Œå¡ç‰‡è¿›åº¦æ¡ç¬é—´æ¶¨åˆ° 82%ï¼Œé¡¶éƒ¨è®¡æ•°å™¨ +55ã€‚
   - **Animation**: æ’­æ”¾è½»å¾®çš„ç²’å­æ•ˆæœ (Confetti)ã€‚

3. **Backend (API)**:

- æ¥æ”¶ POST è¯·æ±‚ã€‚
- å†™å…¥ ProductionLogã€‚
- åŸå­æ›´æ–° Allocation å¿«ç…§ã€‚

1. **Error Handling**:

- è‹¥ API å¤±è´¥ï¼Œå‰ç«¯ Toast æç¤º "ç½‘ç»œå¼€å°å·®äº†ï¼Œæ­£åœ¨é‡è¯•..." å¹¶è‡ªåŠ¨é‡è¯• 3 æ¬¡ã€‚
- è‹¥æœ€ç»ˆå¤±è´¥ï¼Œå›æ»šè¿›åº¦æ¡ï¼Œå¹¶æ ‡è®°å¡ç‰‡ä¸º "åŒæ­¥å¤±è´¥"ã€‚

**4.** **è¾…åŠ©åŠŸèƒ½ï¼šä¿®æ­£ä¸å†å²** **(Correction & History)**

**4.1** **å†å²è®°å½•** **(Log Stream)**

ç‚¹å‡»å¡ç‰‡çš„â€œå†å²æ‘˜è¦â€åŒºåŸŸï¼Œè¿›å…¥è¯¥ä»»åŠ¡çš„è¯¦ç»†æµæ°´é¡µã€‚

- åˆ—è¡¨æ˜¾ç¤º:
  - 1/17 14:00 | +50 æœ‰æ•ˆ | 0 å¼‚å¸¸
  - 1/16 18:00 | +0 æœ‰æ•ˆ | +10 å¼‚å¸¸ (æºæ–‡ä»¶æŸå)
- **æ’¤å›\*\***/\***\*ä¿®æ­£**:
  - ä»…å…è®¸ä¿®æ”¹ **24\*\***å°æ—¶å†…\*\* çš„è®°å½•ã€‚
  - æ“ä½œé€»è¾‘: å®é™…ä¸Šæ˜¯ç”Ÿæˆä¸€æ¡**è´Ÿæ•°**çš„å†²é”€æ—¥å¿— (Revert Log)ï¼Œä¿è¯å®¡è®¡ç—•è¿¹ã€‚

**5.** **æ•°æ®é€»è¾‘ä¸é˜²å‘†** **(Logic & Validation)**

**5.1** **è¾“å…¥æ ¡éªŒ**

- **è¶…é¢é¢„è­¦**: è‹¥ (å·²å®Œæˆ + æœ¬æ¬¡è¾“å…¥) > åˆ†é…æ€»é‡ \* 1.1 (å…è®¸æº¢å‡º 10%)ã€‚
  - æç¤º: "ä½ çš„è¾“å…¥è¶…è¿‡äº†åˆ†é…ä»»åŠ¡é‡ï¼Œè¯·ç¡®è®¤æ˜¯å¦å¤šè¾“äº†ï¼Ÿ" -> å…è®¸å¼ºåˆ¶æäº¤ï¼Œä½†æ ‡è®° IsOverQuotaã€‚
- **è´Ÿæ•°æ‹¦æˆª**: ä¸å…è®¸è¾“å…¥è´Ÿæ•°ï¼ˆä¿®æ­£éœ€èµ°æ’¤å›æµç¨‹ï¼‰ã€‚

**5.2** **çŠ¶æ€æµè½¬**

- å½“ Valid + Excluded >= TargetQuota æ—¶ï¼Œå¡ç‰‡è‡ªåŠ¨æ ‡è®°ä¸º **"\*\***å·²è¾¾æ ‡\*\* **(Completed)"**ï¼Œå¹¶æ²‰åº•æ˜¾ç¤ºã€‚

**6.** **é¢„æœŸäº¤ä»˜æˆæœ** **(Deliverables)**

1. **ç»„ä»¶åº“**: å°è£…å¥½çš„ TaskCard, ReportModal ç»„ä»¶ã€‚
2. **API** **æ¥å£**:
   - GET /api/my/allocations (è·å–æˆ‘çš„ä»»åŠ¡æµ)
   - POST /api/report (æ ¸å¿ƒå¡«æŠ¥æ¥å£)
   - GET /api/report/history/{allocationId} (è·å–æµæ°´)

3. **ä½“éªŒæŒ‡æ ‡**:

- å¡«æŠ¥è€—æ—¶ < 5ç§’ã€‚
- å¼‚å¸¸å½’å› è¦†ç›–ç‡ 100% (æ‰€æœ‰é™¤å¤–é‡éƒ½æœ‰å¯¹åº”çš„ Reason)ã€‚

**7.** **æŠ€æœ¯è½åœ°æŒ‡å—** **(Technical Guidelines)**

**7.1** **é€šä¿¡å±‚** **(Server Actions)**

- **åŸåˆ™**: å‘˜å·¥ç«¯**å®Œå…¨ç¦ç”¨** HTTP API Controllers (GET/POST fetch)ï¼Œå…¨éƒ¨ä½¿ç”¨ Next.js Server Actionsã€‚
- **ä¼˜åŠ¿**:
  - è‡ªåŠ¨è·å¾— Type-Safetyã€‚
  - ç®€åŒ– CSRF é˜²æŠ¤ã€‚
  - ç›´æ¥åœ¨ Server Action ä¸­è°ƒç”¨ Application Serviceã€‚

**7.2** **å³æ—¶åé¦ˆ** **(Optimistic UI)**

- ä½¿ç”¨ `useOptimistic` Hook ç®¡ç†ç•Œé¢çŠ¶æ€ã€‚
- **Code Pattern**:

  ```tsx
  const [optimisticValid, addOptimisticValid] = useOptimistic(
    currentValid,
    (state, newAmount) => state + newAmount,
  );

  async function handleReport(formData: FormData) {
    const amount = Number(formData.get("amount"));
    addOptimisticValid(amount); // ç«‹å³æ›´æ–°UI
    await reportProgressAction(id, amount); // åå°å¼‚æ­¥æäº¤
  }
  ```
